<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RTS QSM with Niivue Viewer</title>
  <link rel="stylesheet" href="./style/grid.css">
  <link rel="stylesheet" href="./style/input.css">
  <script src="https://cdn.jsdelivr.net/pyodide/v0.27.1/full/pyodide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.4/nouislider.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.4/nouislider.min.css" rel="stylesheet"/>

  
</head>
<body>

  <h2>Browser-based QSM using WebAssembly</h2>

<div class="upload-wrapper">


  <label for="magnitude">Upload <b>magnitude image</b> (.nii or .nii.gz):</label>
  <input type="file" id="magnitude" accept=".nii,.nii.gz">

  <label for="phase">Upload <b>phase image</b> (.nii or .nii.gz):</label>
  <input type="file" id="phase" accept=".nii,.nii.gz">
<br>
  <button id="run">Run QSM pipeline</button>
</div>

  <pre id="output">Waiting...</pre>

      <div id="container">
        test1
        <canvas id="gl1"></canvas>
        
    
        <div id="intensity">&nbsp;</div>


        

        <div id="contrastControls" style="width: 80%; margin: 20px auto;" hidden>
          <h2 id="contrastTitle">Contrast</h2>
          <div id="contrastSlider"></div>
          <div style="display: flex; justify-content: space-between; margin-top: 10px;">
            <label id="minContrast" >Min: <input type="number" id="minInput" step="0.1"></label>
            <label id="maxContrast" >Max: <input type="number" id="maxInput" step="0.1"></label>
          </div>
        </div>
        
        <div >
         
          <div id="contrastSlider"></div>

      </div>

      
    <div id="thresholdControls" hidden>
       <h3>Masking Threshold</h3>
    <div id="thresholdSlider" style="width: 80%; margin: 20px auto;"></div>
    <label>Current Threshold: <span id="thresholdValue">75</span></label>

    </div>
      
    <div class="use-mask-wrapper">
  <button id="useMask" hidden>Use Mask</button>
</div>
      </div>
     

  <script type="module">
    import * as niivue from "https://niivue.github.io/niivue/dist/index.js";

    let pyodide;
    const nv = new niivue.Niivue({ onLocationChange: (data) => {
      document.getElementById("intensity").innerHTML = "&nbsp;&nbsp;" + data.string;
    }});





    await nv.attachTo("gl1");
    nv.setMultiplanarPadPixels(5);
    nv.setSliceType(nv.sliceTypeMultiplanar);

    async function initPyodide() {
      document.getElementById("output").textContent = "Loading Pyodide...";
      pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");

      await pyodide.runPythonAsync(`
        import micropip
        await micropip.install("nibabel")
        

      `);
      await pyodide.loadPackage(["numpy", "scipy"]);
      const pythonCode = await fetch("masking3.py").then(r => r.text());
      await pyodide.runPythonAsync(pythonCode);
      document.getElementById("output").textContent = "RTS module loaded.";
  
    }

    async function saveToFS(file, name) {
      const buf = await file.arrayBuffer();
      pyodide.FS.writeFile(name, new Uint8Array(buf));
    }

    function setupContrast(volume) {
      const contrastSlider = document.getElementById("contrastSlider");
      const minCon = document.getElementById("minContrast");
      const maxCon = document.getElementById("maxContrast");
      const minInput = document.getElementById("minInput");
      const maxInput = document.getElementById("maxInput");
      const contrastControls = document.getElementById("contrastControls");

      contrastControls.hidden = false;


      const startMin = volume.cal_min;
      const startMax = volume.cal_max;

      if (contrastSlider.noUiSlider) {
        contrastSlider.noUiSlider.destroy();
      }

      noUiSlider.create(contrastSlider, {
        start: [startMin, startMax],
        connect: true,
        tooltips: true,
        range: {
          min: volume.global_min,
          max: volume.global_max
        }
      });

      minInput.value = startMin.toFixed(2);
      maxInput.value = startMax.toFixed(2);

      contrastSlider.noUiSlider.on('update', (values) => {
        const [min, max] = values.map(parseFloat);
        volume.cal_min = min;
        volume.cal_max = max;
        nv.updateGLVolume();
        minInput.value = min.toFixed(2);
        maxInput.value = max.toFixed(2);
      });

      [minInput, maxInput].forEach((input, i) => {
        input.addEventListener("change", () => {
          const min = parseFloat(minInput.value);
          const max = parseFloat(maxInput.value);
          contrastSlider.noUiSlider.set([min, max]);
        });
      });
    }




    let threshold = 75;


    function setupThreshold() {
    const thresholdControls = document.getElementById("thresholdControls");
    thresholdControls.hidden = false;
    const thresholdSlider = document.getElementById("thresholdSlider");
    const thresholdValue = document.getElementById("thresholdValue");

    noUiSlider.create(thresholdSlider, {
      start: [threshold],
      connect: [true, false],
      range: {
        min: 50,
        max: 100
      },
      step: 1,
      tooltips: true
    });

    thresholdSlider.noUiSlider.on("change", async (values) => {
      thresholdValue.textContent = "Loading...";

      

      


      try {
    
    const runMasking = pyodide.globals.get("run_masking");

    const resultPath = runMasking("magnitude.nii", threshold);

    const resultBytes = pyodide.FS.readFile(resultPath);
    const blob = new Blob([resultBytes], { type: "application/octet-stream" });
    const file = new File([blob], `mask_${Date.now()}.nii`);

    
    await nv.loadFromFile(file);
      console.log(nv.volumes.length)
      nv.removeVolumeByIndex(0);
   
      threshold = parseInt(values[0]);
      thresholdValue.textContent = threshold.toFixed(0);

  } catch (err) {
    console.error(err);

  }
    });

  }
 //run masking
 
 let contrastEnabled = false;
 



document.getElementById("run").addEventListener("click", async () => {
  const out = document.getElementById("output");
  const magnitude = document.getElementById("magnitude").files[0];
  const phase = document.getElementById("phase").files[0];
  if (!magnitude || !phase) {
    out.textContent = "Please upload both magnitude and phase images.";
    return;
  }


  await saveToFS(magnitude, "magnitude.nii");
  await saveToFS(phase, "phase.nii");

  try {
    out.textContent = "Creating initial mask...";
    const runMasking = pyodide.globals.get("run_masking");
    const resultPath = runMasking("magnitude.nii", threshold);

    const resultBytes = pyodide.FS.readFile(resultPath);
    
    const blob = new Blob([resultBytes], { type: "application/octet-stream" });
    pyodide.FS.unlink(resultPath);
    const file = new File([blob], "masking_output.nii");

    out.textContent = "Displaying result in viewer...";

    //make sure to remove the previous volume, if any (in case of multiple runs)
    if (nv.volumes.length > 0) {
  nv.removeVolumeByIndex(0);  
}
    await nv.loadFromFile(file); 
    setupThreshold();
    out.textContent = "Masking result loaded. Adjust threshold as needed.";

    const useMaskButton = document.getElementById("useMask");
    useMaskButton.hidden = false;

  } catch (err) {
    console.error(err);
    out.textContent = "Error: " + err.message;
  }
});


    initPyodide();
  </script>
</body>
</html>
